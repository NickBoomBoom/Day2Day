<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://unpkg.com/cropperjs@next"></script>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
    }
  </style>
  <script>
    class PopupDialog extends HTMLElement {
      constructor() {
        super();
        // 创建影子DOM
        this.attachShadow({ mode: 'open' });
        // 设置初始样式
        this.shadowRoot.innerHTML = `
          <style>
            .popup-container {
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              width: 100%;
              height: 100%;
              background-color: rgba(0, 0, 0, 0.5);
              justify-content: center;
              align-items: center;
              z-index: 9999;
            }
            .popup-content {

              background-color: white;
              padding: 20px;
              border-radius: 5px;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }
          </style>
          <div class="popup-container">
            <div class="popup-content">
              <slot></slot>
              <button id="close-button">关闭</button>
            </div>
          </div>
        `;
        // 获取关闭按钮
        this.closeButton = this.shadowRoot.getElementById('close-button');
        // 添加事件监听器以关闭弹窗
        this.closeButton.addEventListener('click', () => {
          this.$close();
        });
        this.mask = this.shadowRoot.querySelector('.popup-container')
        this.mask.addEventListener('click', () => {
          this.$close()
        })
        this.container = this.shadowRoot.querySelector('.popup-content')
        this.container.addEventListener('click', e => {
          e.stopPropagation()
        })
      }

      connectedCallback() {
      }

      $open() {
        const popupContainer = this.shadowRoot.querySelector('.popup-container');
        popupContainer.style.display = 'flex';
      }

      $close() {
        const popupContainer = this.shadowRoot.querySelector('.popup-container');
        popupContainer.style.display = 'none';
      }
    }

    customElements.define('popup-dialog', PopupDialog);


    class CustomImage extends HTMLElement {
      _viewId = 'custom_image_' + Date.now()
      _dialogId = 'dialog-image_' + Date.now()
      cropperInstance = null
      dialogCropperInstance = null
      dialog = null
      viewer = null
      constructor(props) {
        super()
        console.log(1111, props)
        this.attachShadow({ mode: 'open' });
      }
      connectedCallback() {
        console.log('植入中')

        // this.createDialogCropper()
        this.createViewCropper()
        // this.shadowRoot.appendChild(this.dialog)
        this.shadowRoot.appendChild(this.viewer)
        this.syncAttr(this.cropperInstance)
        // this.syncAttr(this.dialogCropperInstance)



      }
      get src() {
        return this.getAttribute('src')
      }

      get x() {
        return +this.getAttribute('x')
      }
      get y() {
        return +this.getAttribute('y')
      }
      get width() {
        return +this.getAttribute('width')
      }
      get height() {
        return +this.getAttribute('height')
      }
      get matrix() {
        const res = this.getAttribute('matrix') || ''
        if (res) {
          return res.split(',').map(t => +t)
        }
        return []
      }

      get image() {
        const img = new Image()
        img.src = this.src
        return img
      }

      get readOnly() {
        const res = this.getAttribute('readOnly')
        return res === 'true'
      }


      createViewCropper() {
        const container = document.createElement('div')
        container.style.cssText = `
          width: 0;
          height: 0;
          overflow:hidden;
        `
        this.cropperInstance = new window.Cropper.default(this.image, {
          container,
          template: `
              <cropper-canvas background>
                <cropper-image></cropper-image>
                <cropper-shade hidden></cropper-shade>
                <cropper-handle action="select" plain></cropper-handle>
                <cropper-selection id="${this._viewId}" initial-coverage="0.5" movable resizable zoomable>
                  <cropper-handle action="move" theme-color="rgba(255, 255, 255, 0.35)"></cropper-handle>
                    <cropper-handle action="n-resize"></cropper-handle>
                    <cropper-handle action="e-resize"></cropper-handle>
                    <cropper-handle action="s-resize"></cropper-handle>
                    <cropper-handle action="w-resize"></cropper-handle>
                    <cropper-handle action="ne-resize"></cropper-handle>
                    <cropper-handle action="nw-resize"></cropper-handle>
                    <cropper-handle action="se-resize"></cropper-handle>
                    <cropper-handle action="sw-resize"></cropper-handle>
                </cropper-selection>
              </cropper-canvas>
            `
        })


        this.viewer = document.createElement('div')
        const button = document.createElement('button')
        button.innerHTML = `open`
        this.viewer.innerHTML = `
          <cropper-viewer selection="#${this._viewId}"></cropper-viewer>
        `
        button.addEventListener('click', () => {
          this.dialog.$open()
        })
        this.viewer.appendChild(container)
        this.viewer.appendChild(button)

      }

      createDialogCropper() {
        this.dialog = document.createElement('popup-dialog')
        const container = document.createElement('div')
        this.dialog.appendChild(container)
        this.dialogCropperInstance = new window.Cropper.default(this.image, {
          container,
          template: `
            <div style="width: 50vw;height: 40vh">
              <cropper-canvas background>
                  <cropper-image></cropper-image>
                  <cropper-shade hidden></cropper-shade>
                  <cropper-handle action="select" plain></cropper-handle>
                  <cropper-selection id="${this._dialogId}" initial-coverage="0.5" movable resizable zoomable>
                    <cropper-handle action="move" theme-color="rgba(255, 255, 255, 0.35)"></cropper-handle>
                    <cropper-handle action="n-resize"></cropper-handle>
                    <cropper-handle action="e-resize"></cropper-handle>
                    <cropper-handle action="s-resize"></cropper-handle>
                    <cropper-handle action="w-resize"></cropper-handle>
                    <cropper-handle action="ne-resize"></cropper-handle>
                    <cropper-handle action="nw-resize"></cropper-handle>
                    <cropper-handle action="se-resize"></cropper-handle>
                    <cropper-handle action="sw-resize"></cropper-handle>
                  </cropper-selection>
                </cropper-canvas>
                <div>
                  <cropper-viewer selection="#${this._dialogId}"></cropper-viewer>
                </div>
            </div>
          `
        })
      }


      syncAttr(instance) {
        const selection = instance.getCropperSelection()
        const imageArea = instance.getCropperImage()
        console.log(333, selection, imageArea)
        console.log(1111, this.x, this.y, this.width, this.height, this.matrix)
        selection.$change(this.x, this.y, this.width, this.height)
        imageArea.$transform(this.matrix)
      }


    }
    window.customElements.define('custom-image', CustomImage)


  </script>

</head>

<body>

  <custom-image src="https://tu.sioe.cn/gj/qiege/image.jpg" x="118" y="66" width="82" height="100"
    matrix="0.9668508287292817,0,0,0.9668508287292817,-12,-104.203125">

  </custom-image>



  <hr>

  <script>
    const content = document.createElement('div')
    const img = new Image()
    img.src = "https://tu.sioe.cn/gj/qiege/image.jpg"
    new window.Cropper.default(img, {
      container: content,
      template: `
              <cropper-canvas background>
                  <cropper-image></cropper-image>
                  <cropper-shade hidden></cropper-shade>
                  <cropper-handle action="select" plain></cropper-handle>
                  <cropper-selection id="test" initial-coverage="0.5" movable resizable zoomable>
                    <cropper-handle action="move" theme-color="rgba(255, 255, 255, 0.35)"></cropper-handle>
                    <cropper-handle action="n-resize"></cropper-handle>
                    <cropper-handle action="e-resize"></cropper-handle>
                    <cropper-handle action="s-resize"></cropper-handle>
                    <cropper-handle action="w-resize"></cropper-handle>
                    <cropper-handle action="ne-resize"></cropper-handle>
                    <cropper-handle action="nw-resize"></cropper-handle>
                    <cropper-handle action="se-resize"></cropper-handle>
                    <cropper-handle action="sw-resize"></cropper-handle>
                  </cropper-selection>
                </cropper-canvas>
                <div>
                  <cropper-viewer selection="#test"></cropper-viewer>
                </div>
          `
    })


    document.body.appendChild(content)
  </script>
</body>

</html>